#!/bin/bash

# ==============================================================================
# CONFIGURATION
# ==============================================================================

# Get script directory for sourcing libraries
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Source constants first to get centralized paths
LIB_DIR="$SCRIPT_DIR/lib"
source "$LIB_DIR/constants.sh"

# Set paths from constants
# shellcheck disable=SC2034  # Used in sourced files
export CONFIG_DIR="$DEV_CONFIG_DIR"
GLOBAL_CONFIG="$DEV_GLOBAL_CONFIG"
PROJECT_CONFIG="$DEV_PROJECT_CONFIG"
LANGUAGES_DIR="$DEV_LANGUAGES_DIR"
TEMPLATES_DIR="$DEV_TEMPLATES_DIR"
CACHE_DIR="$DEV_CACHE_DIR"

# Source library modules
source "$LIB_DIR/utils.sh"
source "$LIB_DIR/config.sh"
source "$LIB_DIR/vm.sh"
source "$LIB_DIR/containers.sh"
source "$LIB_DIR/templates.sh"
source "$LIB_DIR/languages.sh"
source "$LIB_DIR/security.sh"
source "$LIB_DIR/project_init.sh"



# ==============================================================================
# MAIN EXECUTION
# ==============================================================================

# Initialize default values
DOCKERFILE="Dockerfile"
COMMAND="run"
CUSTOM_TAG=""
CUSTOM_NAME=""
AUTO_YES=false
TARGET_PLATFORM=""
CUSTOM_ENV_VARS=()
CUSTOM_ENV_FILES=()

# Process command line arguments
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            usage
            ;;
        list)
            list_templates
            ;;
        templates)
            case "$2" in
                --help|-h)
                    show_command_help "templates"
                    exit 0
                    ;;
                update)
                    update_templates
                    exit 0
                    ;;
                check)
                    check_template_updates
                    exit 0
                    ;;
                prune)
                    prune_old_templates
                    exit 0
                    ;;
                cleanup)
                    # Handle optional days parameter and --yes flag
                    days="$3"
                    shift 3  # Remove 'templates', 'cleanup', and days
                    while [[ $# -gt 0 ]]; do
                        case $1 in
                            --yes|-y)
                                AUTO_YES=true
                                shift
                                ;;
                            *)
                                echo "‚ùå Error: Unknown flag for 'templates cleanup': $1"
                                exit 1
                                ;;
                        esac
                    done
                    cleanup_unused_templates "$days"
                    exit 0
                    ;;
                stats)
                    show_template_stats
                    exit 0
                    ;;
                *)
                    echo "‚ùå Error: Unknown templates subcommand '$2'"
                    echo "Available: update, check, prune, cleanup, stats"
                    exit 1
                    ;;
            esac
            ;;
        config)
            case "$2" in
                --help|-h)
                    show_command_help "config"
                    exit 0
                    ;;
                *)
                    shift 1  # Remove 'config'
                    # Parse config subcommand and flags
                    subcommand="$1"
                    shift 1
                    while [[ $# -gt 0 ]]; do
                        case $1 in
                            --yes|-y)
                                AUTO_YES=true
                                shift
                                ;;
                            *)
                                echo "‚ùå Error: Unknown flag for 'config' command: $1"
                                exit 1
                                ;;
                        esac
                    done
                    handle_config_command "$subcommand"
                    ;;
            esac
            ;;
        devcontainer)
            case "$2" in
                --help|-h)
                    show_command_help "devcontainer"
                    exit 0
                    ;;
                *)
                    shift 1  # Remove 'devcontainer'
                    # Parse devcontainer subcommand and flags
                    language=""
                    dockerfile_path="./Dockerfile"
                    while [[ $# -gt 0 ]]; do
                        case $1 in
                            --yes|-y)
                                AUTO_YES=true
                                shift
                                ;;
                            -f|--file)
                                dockerfile_path="$2"
                                shift 2
                                ;;
                            -*)
                                echo "‚ùå Error: Unknown flag for 'devcontainer' command: $1"
                                exit 1
                                ;;
                            *)
                                if [[ -z "$language" ]]; then
                                    language="$1"
                                else
                                    echo "‚ùå Error: Multiple language arguments provided: $language and $1"
                                    exit 1
                                fi
                                shift
                                ;;
                        esac
                    done
                    handle_devcontainer_command "$language" "$dockerfile_path"
                    ;;
            esac
            ;;
        new)
            shift 1
            handle_new_command "$@"
            exit 0
            ;;

        -f|--file)
            DOCKERFILE="$2"
            shift 2
            ;;
        -t|--tag)
            CUSTOM_TAG="$2"
            shift 2
            ;;
        -n|--name)
            CUSTOM_NAME="$2"
            shift 2
            ;;
        -y|--yes)
            AUTO_YES=true
            shift
            ;;
        --debug)
            export DEBUG=true
            shift
            ;;
        -v|--verbose)
            export VERBOSE=true
            shift
            ;;
        --trace)
            export TRACE=true
            shift
            ;;
        --platform)
            TARGET_PLATFORM="$2"
            shift 2
            ;;
        -e|--env)
            if [[ -z "$2" ]]; then
                echo "‚ùå Error: -e flag requires an argument"
                echo "Usage: dev -e 'VAR=value' or dev -e VAR"
                exit 1
            fi
            CUSTOM_ENV_VARS+=("$2")
            shift 2
            ;;
        --env-file)
            if [[ -z "$2" ]]; then
                echo "‚ùå Error: --env-file flag requires an argument"
                exit 1
            fi
            CUSTOM_ENV_FILES+=("$2")
            shift 2
            ;;
        run|build|clean|shell)
            COMMAND="$1"
            shift
            ;;
        help)
            if [[ -n "$2" ]]; then
                show_command_help "$2"
            else
                usage
                echo ""
                echo "Available help topics:"
                echo "  $(basename "$0") help new           # Template creation help"
                echo "  $(basename "$0") help config        # Configuration help"
                echo "  $(basename "$0") help templates     # Template management help"
                echo "  $(basename "$0") help env           # Environment management help"
                echo "  $(basename "$0") arch               # Architecture and platform info"
                echo "  $(basename "$0") disk               # Show disk usage information"
                echo "  $(basename "$0") troubleshoot       # Troubleshooting guide"
            fi
            exit 0
            ;;
        debug)
            case "$2" in
                --check-vm)
                    debug_check_vm
                    ;;
                --check-docker)
                    debug_check_docker
                    ;;
                *)
                    debug_show_info
                    ;;
            esac
            exit 0
            ;;
        troubleshoot)
            show_command_help "troubleshoot"
            exit 0
            ;;
        disk)
            show_disk_usage
            exit 0
            ;;
        arch|architecture)
            case "$2" in
                --help|-h)
                    show_command_help "arch"
                    exit 0
                    ;;
                *)
                    echo "üíª Architecture Information:"
                    echo "   Host architecture: $(detect_architecture)"
                    echo "   Default platform: linux/$(detect_architecture)"
                    echo ""
                    echo "Supported platforms:"
                    echo "   linux/amd64    - Intel/AMD 64-bit (x86_64)"
                    echo "   linux/arm64    - ARM 64-bit (Apple Silicon, ARM servers)"
                    echo ""
                    echo "Usage:"
                    echo "   $(basename "$0") --platform linux/arm64    # Force ARM64 build"
                    echo "   $(basename "$0") --platform linux/amd64    # Force AMD64 build"
                    echo "   $(basename "$0")                          # Auto-detect (recommended)"
                    exit 0
                    ;;
            esac
            ;;
        security)
            case "$2" in
                --help|-h)
                    echo "Security commands:"
                    echo "  dev security check         Comprehensive security check (Dockerfile + vulnerabilities)"
                    exit 0
                    ;;
                check)
                    if [[ -f "Dockerfile" ]]; then
                        security_check "Dockerfile"
                    else
                        echo "‚ùå No Dockerfile found in current directory"
                        exit 1
                    fi
                    exit 0
                    ;;
                *)
                    echo "‚ùå Error: Unknown security subcommand '$2'"
                    echo "Available: check"
                    exit 1
                    ;;
            esac
            ;;
        env)
            # Pass all remaining arguments to handle_env_command
            shift 1  # Remove 'env'
            handle_env_command "$@"
            exit 0
            ;;
        *)
            echo "‚ùå Error: Unknown option '$1'"
            echo "Available commands: run, shell, build, clean, new, devcontainer, list, config, templates, security, env, help, troubleshoot, debug, disk, arch"
            echo "Use --help for usage information or 'help <command>' for command-specific help."
            exit 1
            ;;
    esac
done

if [[ $# -gt 0 ]]; then
    echo "‚ùå Error: Unrecognized arguments: $*"
    echo ""
    echo "üí° Common issue: Environment variables with spaces need proper quoting:"
    echo "   ‚úÖ Correct: dev -e 'VAR=value with spaces' shell"
    echo "   ‚úÖ Correct: dev -e \"VAR=value with spaces\" shell"  
    echo "   ‚ùå Wrong:   dev -e VAR=\"value with spaces\" shell"
    echo ""
    echo "The quotes must wrap the entire VAR=value argument, not just the value."
    exit 1
fi

load_config

# --- Validate Requirements ---
if [[ "$COMMAND" != "clean" ]]; then
    if [ ! -f "$DOCKERFILE" ]; then
        echo "‚ùå Error: No Dockerfile found at '$DOCKERFILE'"
        echo ""
        echo "üí° Suggestions:"
        echo "   ‚Ä¢ Create from template: '$(basename "$0") new <language>'"
        echo "   ‚Ä¢ Use different file: '$(basename "$0") -f /path/to/Dockerfile'"
        echo "   ‚Ä¢ See available templates: '$(basename "$0") list'"
        echo "   ‚Ä¢ Get help: '$(basename "$0") help new'"
        exit 1
    fi
fi

# --- Generate Names ---
PROJECT_NAME=$(basename "$(pwd)" | tr '[:upper:]' '[:lower:]')
IMAGE_NAME="${CUSTOM_TAG:-${CONTAINER_PREFIX}-img-${PROJECT_NAME}}"
CONTAINER_NAME="${CUSTOM_NAME:-${CONTAINER_PREFIX}-ctn-${PROJECT_NAME}}"

# --- Main Logic ---
case $COMMAND in
    run|shell)
        prepare_and_run_container "$COMMAND"
        ;;
    build)
        echo "üî® Building container image for '$PROJECT_NAME'..."
        ensure_vm_running
        platform_flag=$(get_platform_flag "$TARGET_PLATFORM")
        build_image "$platform_flag"
        echo "‚úÖ Image '$IMAGE_NAME' built successfully."
        ;;
        
    clean)
        echo "üßπ Cleaning up containers and images for '$PROJECT_NAME'..."
        ensure_vm_running
        cleanup_existing_container
        if orb -m "$VM_NAME" sudo docker images --format '{{.Repository}}' | grep -q "^${IMAGE_NAME}$"; then
            echo "   -> Removing image '$IMAGE_NAME'..."
            orb -m "$VM_NAME" sudo docker rmi "$IMAGE_NAME" >/dev/null 2>&1
        fi
        echo "‚úÖ Cleanup complete."
        ;;
esac